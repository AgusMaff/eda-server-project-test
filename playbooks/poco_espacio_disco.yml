---
- name: Responder a poco espacio en disco
  hosts: EDA-Test  
  become: yes
  
  tasks:
    - name: Mostrar información de la alerta
      debug:
        msg: 
          - "ALERTA: Poco espacio en disco"
          - "Host afectado: {{ host_afectado }}"
          - "Uso de disco: {{ disk_usage }}%"
          - "Timestamp: {{ timestamp }}"
    
    - name: Mostrar espacio disponible en disco
      shell: df -h /
      register: disk_space
      
    - name: Mostrar detalles del espacio en disco
      debug:
        msg: 
          - "Espacio en disco:"
          - "{{ disk_space.stdout_lines }}"
    
    - name: Encontrar archivos grandes en /tmp
      shell: find /tmp -type f -size +10M -ls 2>/dev/null || echo "No hay archivos grandes en /tmp"
      register: large_files_tmp
      
    - name: Mostrar archivos grandes en /tmp
      debug:
        msg:
          - "Archivos grandes en /tmp:"
          - "{{ large_files_tmp.stdout_lines }}"
    
    - name: Encontrar logs grandes
      shell: find /var/log -name "*.log" -size +50M -ls 2>/dev/null || echo "No hay logs grandes"
      register: large_logs
      
    - name: Mostrar logs grandes
      debug:
        msg:
          - "Logs grandes encontrados:"
          - "{{ large_logs.stdout_lines }}"
    
    - name: Limpiar archivos temporales 
      shell: |
        find /tmp -type f -atime +7 -delete 2>/dev/null || true
        apt-get clean 2>/dev/null || true
      when: disk_usage >= 95
      register: cleanup_done
      
    - name: Confirmar limpieza
      debug:
        msg: "Limpieza de archivos temporales realizada"
      when: cleanup_done is changed
      
    - name: Mostrar espacio después de limpieza
      shell: df -h /
      register: disk_space_after
      when: cleanup_done is changed
      
    - name: Espacio después de limpieza
      debug:
        msg:
          - "Espacio después de limpieza:"
          - "{{ disk_space_after.stdout_lines }}"
      when: cleanup_done is changed
      
    - name: Acción completada
      debug:
        msg: "✅ Respuesta a alerta de disco completada"
